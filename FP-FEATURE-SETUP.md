# FP（ファイナンシャルプランナー）機能セットアップ

このドキュメントでは、顧客情報管理システムにFP機能を追加する手順を説明します。

## 実装された機能

### 1. データベース拡張
- `customer_leads`テーブルに`fp_info`フィールド（JSONB）を追加
- FP関連の情報を柔軟に格納可能

### 2. FP情報の管理項目
- FP担当者名
- FP会社名
- 初回連絡日
- 次回FP面談予定
- 金融目標（複数選択可能）
- 月収・月支出
- ローン金額・条件
- FP担当者からの備考

### 3. UI機能
- 顧客詳細ページにFP情報セクションを追加
- 「もっと見る」ボタンで折りたたみ可能
- 編集モードでFP情報を更新可能
- 新規顧客登録時にもFP情報を入力可能

## セットアップ手順

### 1. データベースの更新
```bash
# SupabaseのSQLエディタで以下を実行
psql -f database-fp-fields.sql
```

または、SupabaseのダッシュボードでSQLエディタを開いて、`database-fp-fields.sql`の内容を実行してください。

### 2. アプリケーションの再起動
```bash
npm run dev
```

## 使用方法

### 顧客詳細ページでのFP情報管理
1. 顧客詳細ページの「基本情報」タブを開く
2. 「FP情報」セクションの「もっと見る」ボタンをクリック
3. FP情報が未登録の場合は「FP情報を登録」ボタンをクリック
4. 既存のFP情報がある場合は「FP情報を編集」ボタンをクリック

### 新規顧客登録時のFP情報入力
1. 新規顧客登録フォームの「FP情報（オプション）」セクションで入力
2. 必須項目ではないため、空欄でも登録可能

## 技術的な詳細

### データ構造
```json
{
  "fp_assigned": "FP担当者名",
  "fp_company": "FP会社名",
  "fp_contact_date": "2024-01-01",
  "financial_goals": ["住宅購入", "老後資金準備"],
  "current_assets": {
    "savings": 10000000,
    "investments": 5000000,
    "insurance": 20000000
  },
  "monthly_income": 500000,
  "monthly_expenses": 300000,
  "loan_amount": 30000000,
  "loan_terms": 35,
  "interest_rate": 0.8,
  "repayment_method": "元金均等返済",
  "fp_notes": "FP担当者からの備考",
  "next_fp_meeting": "2024-02-01",
  "fp_status": "active"
}
```

### API エンドポイント
- `PUT /api/leads/[id]/fp-info` - FP情報の更新
- `GET /api/leads/[id]/fp-info` - FP情報の取得

### 型定義
- `types/leads.ts`に`FPInfo`インターフェースを追加
- `CustomerLead`インターフェースに`fp_info`フィールドを追加

## 注意事項

1. **データベース更新**: 既存のデータがある場合は、バックアップを取ってから実行してください
2. **権限設定**: SupabaseのRLSポリシーで適切な権限設定が必要です
3. **バリデーション**: 入力値の検証は基本的なもののみ実装されています

## 今後の拡張予定

- FP情報の検索・フィルタリング機能
- FP担当者別の顧客一覧表示
- FP面談のスケジュール管理
- FP情報のエクスポート機能
- FP情報の変更履歴管理

## トラブルシューティング

### よくある問題

1. **FP情報が表示されない**
   - データベースの更新が完了しているか確認
   - ブラウザのキャッシュをクリア

2. **FP情報の更新が失敗する**
   - Supabaseの接続設定を確認
   - 認証が正しく動作しているか確認

3. **型エラーが発生する**
   - `npm run build`でビルドエラーがないか確認
   - TypeScriptの型定義が正しく読み込まれているか確認
