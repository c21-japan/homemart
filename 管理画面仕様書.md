# 管理画面仕様書

## 1. 概要
- 対象: `app/admin` 以下の管理画面（Next.js / Supabase ベース）
- 目的: 不動産業務の顧客・物件・リード・勤怠・社内申請・チラシ施策・リフォーム実績などを一元管理
- 特記事項: 複数ページでモックデータやTODO実装が残っており、現状は「UI/フローはあるがデータ未接続」の画面が混在

## 2. 共通UI・ナビゲーション
- 共通レイアウト: `app/admin/layout.tsx`
- 左サイドバー: ダッシュボード / 顧客管理 / 物件管理 / リード管理 / 勤怠管理 / パートタイム勤怠 / 内部申請 / 問い合わせ / リフォーム案件 / ユーザー管理 / メディア管理 / レポート / 設定
- 上部バー: 日付・時刻表示
- 画面によっては `components/AdminNavigation.tsx` も存在するが、現在はレイアウト側のサイドバーが主

## 3. 権限・ロール
- 定義: `lib/auth/permissions.ts`
- ロール: `STAFF` / `ADMIN` / `OWNER`
- 権限種別: `VIEW` / `CREATE` / `EDIT` / `DELETE` / `APPROVE` / `EXPORT`
- ページ単位のアクセス権: `PAGE_PERMISSIONS` に定義
- 備考: 一部ページはサンプル権限チェックのみで、実認証連携は未統合（`currentUser` が未実装）

## 4. データソース・連携
- DB: Supabase
- 主なテーブル（実装から推定）
- `customers`（顧客）
- `properties`（物件）
- `leads`（リード）
- `inquiries`（問い合わせ）
- `internal_applications`（社内申請）
- `part_time_employees` / `part_time_attendance` / `part_time_attendance_realtime`
- `reform_projects`（施工実績）
- `documents`（書類）※画面はモック
- `checklists` / `checklist_items` / `meetings` / `meeting_notes` / `tasks` / `reminders` ※顧客詳細で参照
- 外部連携
- GitHub API: 画像管理（/admin/media）
- Google API: 位置情報（逆ジオコーディング）
- LINE / PLAUD / Century21 などの連携APIは `app/api/integrations/*` で実装

---

## 5. 画面別仕様（管理画面）

### /admin（管理画面トップ）
- 目的: 経営状況のダッシュボード表示とクイックアクション
- 機能
  - 統計カード（総顧客数、媒介契約、チェックリスト、売上）
  - 最近の活動一覧
  - 今月の目標進捗
  - クイックアクション（新規顧客 / 物件登録 / チェックリスト / レポート）
- データ: 現在は固定値（モック）

### /admin/dashboard
- 目的: 簡易ダッシュボード
- 機能: リード数、媒介契約数、チェックリスト数の表示
- データ: 固定値（モック）

### /admin/customers（顧客管理一覧）
- 目的: 売却・購入・リフォーム顧客の一覧管理
- 機能
  - KPI表示（総顧客数、新規顧客、保留・期限切れなど）※一部未実装
  - カテゴリタブ（全件 / 売却 / 購入 / リフォーム）
  - 検索（氏名・カナ・電話・メール）
  - リアルタイム更新（Supabase Realtime）
  - アクション（報告書送信 / PDF生成）※現状アラートのみ
- データ: `customers` 取得

### /admin/customers/new（顧客新規作成）
- 目的: 顧客情報の新規登録
- 機能
  - 基本情報入力（氏名・連絡先・住所・担当者・優先度など）
  - 物件情報、売却/購入/リフォーム専用項目をカテゴリに応じて入力
  - 打ち合わせ記録（タイトル、日時、内容、写真）
  - バリデーション（カテゴリ別必須項目チェック）
- データ: Supabaseへ insert

### /admin/customers/[id]（顧客詳細）
- 目的: 顧客の詳細確認・編集・関連情報の一覧
- 機能
  - 基本情報表示/編集
  - 売却詳細 / 購入詳細 / リフォーム詳細（カテゴリ別表示）
  - 打ち合わせ記録一覧
  - チェックリスト一覧（項目と進捗）
  - アクション（編集・削除）
  - 統計/最近の更新
- データ: `customers` + 関連テーブル（`properties`, `checklists`, `meetings`, `documents`, `tasks`, `reminders`）

---

### /admin/properties（物件管理一覧）
- 目的: 登録物件の管理・編集
- 機能
  - 検索（物件名/住所）
  - ステータスフィルタ（空室/契約中/売却済み）
  - ページネーション（20件/ページ）
  - 物件詳細・編集への導線
  - 売主顧客情報の紐付け表示
- データ: `properties` + `customers`

### /admin/properties/new（物件新規登録）
- 目的: 物件情報の登録
- 機能
  - 基本情報: 物件名、住所、価格、物件種別、ステータス、売主、紹介フラグ
  - 詳細情報: 築年数、階数、面積、部屋数、浴室数、設備（駐車場/バルコニー/エレベーター）
  - 価格詳細: 管理費、共益費、リフォーム費用、その他費用
  - 交通アクセス: 路線、最寄駅、駅距離
  - 周辺環境: 施設・環境説明
  - 契約条件: 取引種別（売却/購入/リフォーム）、希望時期、ペット可/喫煙可
  - 写真アップロード: 最大30枚、ドラッグ&ドロップ並び替え
  - その他: 物件説明、タグ、備考
- データ: 現状はコンソール出力のみ（TODO）

### /admin/properties/[id]（物件詳細）
- 目的: 物件情報の詳細確認
- 機能: 物件詳細表示、売主情報表示、編集リンク
- データ: `properties` + 売主 `customers`

### /admin/properties/[id]/edit（物件編集）
- 目的: 物件情報の編集
- 機能: フォームで編集、更新保存
- データ: `properties`

### /admin/properties-list（物件公開管理）
- 目的: 公開中/おすすめ物件の管理
- 機能
  - ビュー切替（全件/公開中/おすすめ）
  - 検索（名前/都道府県/市区町村）
  - ソート（作成日/価格/名前）
  - 公開ステータス切替（published/draft）
  - おすすめ切替（featured）
  - 削除
- データ: `properties`

---

### /admin/leads（リード管理一覧）
- 目的: リード対応状況の管理
- 機能
  - ステータスフィルタ（新規/連絡済/見込みあり/提案中/交渉中/成約）
  - 検索（名前/メール/電話/会社名）
  - ステータス更新
  - メモ追加（notes）
  - リード詳細モーダル
- データ: `leads`

### /admin/leads/new（リード新規追加）
- 目的: リードの手動登録
- 機能: 名前、メール、電話、興味物件、予算、予定時期、メモ、流入元
- データ: 現状はコンソール出力のみ（TODO）

### /admin/leads/[id]（リード詳細）
- 目的: リード詳細と契約・チェックリスト管理
- 機能
  - タブ: 基本情報 / 写真 / 媒介契約 / チェックリスト
  - 媒介契約の取得（売却の場合）
  - チェックリスト更新（項目チェック、ファイル添付）
  - FP情報更新
- データ: `leads` + `agreements` + `checklists` 系

---

### /admin/inquiries（お問い合わせ管理）
- 目的: 問い合わせ一覧と対応
- 機能
  - 一覧表示（新着/全件）
  - 詳細パネルで本文確認
  - 新着 → 既読更新
- データ: `inquiries`

---

### /admin/documents（書類管理）
- 目的: 書類の一覧・管理
- 機能: カテゴリフィルタ、ダウンロード/削除
- データ: モック（UIのみ）

### /admin/documents/upload（書類アップロード）
- 目的: 書類の登録
- 機能: 書類名、カテゴリ、関連物件、タグ、説明、ファイルアップロード
- データ: TODO

---

### /admin/internal-applications（社内申請一覧）
- 目的: 有給/病気/経費/その他申請の管理
- 機能
  - フィルタ（種別・ステータス）
  - ステータス更新（承認/却下）
  - 更新時にメール送信（/api/send-application-status-email）
- データ: `internal_applications`

### /admin/internal-applications/new（社内申請作成）
- 目的: 申請種別を選択しフォームへ遷移
- 機能: 申請種別選択 → 各フォームページへ

### /admin/internal-applications/forms/*
- 種類: `paid-leave` / `sick-leave` / `expense` / `other`
- 目的: 申請内容の入力と送信
- 機能: 申請フォーム入力、送信後は一覧に戻る

### /admin/internal-applications/[id]
- 目的: 申請詳細の確認とステータス更新

---

### /admin/attendance（勤怠管理）
- 目的: 社員の勤怠確認と集計
- 機能
  - 期間・従業員フィルタ
  - 出退勤・勤務時間表示
  - 総労働時間の集計
  - CSV出力
- データ: `attendance` 系API（`lib/supabase/attendance`）

### /admin/attendance/new（勤怠登録）
- 目的: 手動で勤怠記録を追加
- 機能: 従業員名、日付、出勤/退勤時刻、休憩、ステータス、備考
- データ: TODO

---

### /admin/part-time-attendance（アルバイト勤怠）
- 目的: パート・アルバイトの勤怠管理
- 機能
  - 従業員選択、年月フィルタ
  - 勤怠記録一覧
  - リアルタイム勤怠（5秒/1分更新）
  - 月次カレンダー表示
- データ: `part_time_employees`, `part_time_attendance`, `part_time_attendance_realtime`

### /admin/part-time-attendance/form
- 目的: 出退勤打刻（位置情報付き）
- 機能
  - 従業員選択
  - 出勤/退勤選択
  - 位置情報取得（GPS + 逆ジオコーディング）
  - メモ入力
- データ: `/api/part-time-attendance/realtime`

### /admin/part-time-attendance/shift-request
- 目的: 勤務可能日の一括申請
- 機能
  - 従業員選択
  - 日付・時間帯入力 → 一覧に追加
  - 時間帯重複チェック
  - 一括送信
- データ: `/api/shift-requests`

### /admin/part-time-attendance/reports
- 目的: 勤怠レポート確認（UIあり）

---

### /admin/flyers（チラシマーケティング）
- 目的: チラシ配布と反応の分析
- 機能
  - 週次配布枚数/回数/デザイン数/エリア数
  - デザイン別反応率ランキング
  - エリア別反応率
  - AI分析の提案表示
  - 配布記録/問い合わせ/デザイン管理への導線
- データ: `server/actions/flyers.ts` の集計

### /admin/flyers/distributions
- 目的: 配布記録一覧
- 機能: 配布記録の一覧表示

### /admin/flyers/distributions/new
- 目的: 配布記録の新規登録

### /admin/flyers/inquiries
- 目的: チラシ経由問い合わせの管理

### /admin/flyers/inquiries/new
- 目的: チラシ問い合わせの新規登録

### /admin/flyers/designs
- 目的: チラシデザイン管理

### /admin/flyers/designs/new
- 目的: チラシデザインの新規登録

### /admin/flyers/analysis
- 目的: 詳細な分析レポート表示

---

### /admin/reform-projects（施工実績管理）
- 目的: リフォーム実績の掲載管理
- 機能
  - 施工前/施工後の画像登録
  - タイトル・説明の登録
  - 追加・編集・削除
- データ: `reform_projects`

### /admin/reform-workers（リフォーム職人管理）
- 目的: 職人の成績・ランキング管理
- 機能: 職人別の成績・インセンティブ・施工品質スコアなど
- データ: モック

---

### /admin/team-performance（チーム成績管理）
- 目的: 店舗・チーム・個人成績の集計
- 機能: 月次目標と達成率、ランキング
- データ: モック

### /admin/career-path（キャリアパス管理）
- 目的: 営業人材の成長ステップ可視化
- 機能: キャリアゴール一覧と進捗、社員ごとの目標達成状況
- データ: モック

---

### /admin/media（画像・メディア管理）
- 目的: Webサイト用画像の管理
- 機能
  - カテゴリ別画像一覧
  - 画像アップロード（最大20枚、5MB以下）
  - GitHubへのアップロード（API経由）
  - 削除
- データ: 現状はサンプルデータ + GitHub API連携予定

---

### /admin/users（ユーザー管理）
- 目的: 社員アカウントと権限管理
- 機能
  - 権限チェック（Owner/Adminのみ）
  - ユーザー一覧（サンプルデータ）
  - 権限表示
  - 編集・新規作成への導線
- データ: まだモック

### /admin/users/new
- 目的: 新規ユーザー作成
- 機能: 名前/姓/メール/役割/部署/役職を入力して作成
- データ: `/api/admin/users` へPOST（TODO）

### /admin/users/[id]/edit
- 目的: ユーザー編集
- 機能: 権限/部署/役職などの更新

---

### /admin/settings/users
- 目的: 承認待ちユーザー・権限管理
- 機能
  - 承認待ちユーザーの承認/却下
  - アクティブユーザーの権限編集
- データ: モック

---

### /admin/search
- 目的: 全体検索
- 機能: 物件/問い合わせ/リード/リフォーム案件を横断検索
- データ: Supabaseから各テーブル検索

---

### /admin/register
- 目的: 社内ユーザー登録申請
- 機能
  - `@century21.group` ドメイン限定
  - 登録後、管理者通知APIへ送信（TODO）
  - 成功後は管理画面へリダイレクト
- データ: `/api/auth/register`

---

## 6. 補足（自動処理・バックグラウンド）
- 日次運用タスク: `/api/cron/daily-tasks` で統計更新/チェックリストリマインド等
- 管理者エスカレーション: `/api/cron/manager`
- チラシ分析の週次処理: `/api/cron/weekly-flyer-analysis`
- 管理画面向け統計: `/api/admin/stats` （モック）

---

## 7. 既知の未実装・モック一覧
- /admin, /admin/dashboard, /admin/reports, /admin/documents, /admin/media, /admin/team-performance, /admin/career-path, /admin/reform-workers, /admin/settings/users はモックデータ中心
- /admin/properties/new, /admin/leads/new, /admin/attendance/new はAPI未接続（コンソール出力）
- 認証・権限は一部画面で未統合
