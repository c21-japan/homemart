# 🏠 センチュリー21ホームマート - 顧客管理システム

## 📋 概要

このシステムは、不動産会社向けの包括的な顧客管理システムです。売却・購入・リフォームの3カテゴリで顧客を管理し、媒介契約の自動化、チェックリスト管理、原価管理などの機能を提供します。

## ✨ 主な機能

### 🏠 顧客管理
- **3カテゴリ管理**: 売却・購入・リフォーム
- **動的フォーム**: 物件種別（マンション/土地/戸建）に応じた入力項目
- **既存顧客連携**: リフォーム案件での既存顧客検索・選択

### 📊 売却管理
- **媒介契約管理**: 専属専任/専任/一般の種別管理
- **自動報告**: 媒介種別に応じた定期報告の自動化
- **期限管理**: 媒介開始+3ヶ月の自動期限設定
- **報告手段**: メール自動送信 or PDF生成（郵送用）

### 🏗️ リフォーム管理
- **原価管理**: 材料費・外注費・交通費・その他
- **収益分析**: 見込み売上・原価・粗利・粗利率の自動計算
- **進捗管理**: ステータスと進捗率の可視化

### ✅ チェックリスト・通知
- **カテゴリ別テンプレート**: 売却・購入・リフォーム用の標準チェックリスト
- **自動通知**: 期日超過・媒介期限リマインドの自動通知
- **エスカレーション**: 未対応案件の管理者への自動通知

## 🚀 セットアップ手順

### 1. 環境変数の設定

`.env.local`ファイルに以下を追加してください：

```env
# Supabase設定
NEXT_PUBLIC_SUPABASE_URL=your_supabase_url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_supabase_anon_key
SUPABASE_SERVICE_ROLE_KEY=your_supabase_service_role_key

# Clerk認証
CLERK_PUBLISHABLE_KEY=your_clerk_publishable_key
CLERK_SECRET_KEY=your_clerk_secret_key

# メール送信（Mailjet）
MAILJET_API_KEY=your_mailjet_api_key
MAILJET_SECRET_KEY=your_mailjet_secret_key
MAILJET_FROM_EMAIL=your_verified_sender_email

# ベースURL
NEXT_PUBLIC_BASE_URL=https://your-domain.com
```

### 2. データベースのセットアップ

#### Supabaseマイグレーションの実行

1. Supabaseダッシュボードにアクセス
2. SQLエディタを開く
3. 以下のファイルを実行：

```bash
# マイグレーションファイルを実行
psql -d your_database -f supabase/migrations/20250101000000_customer_suite.sql
```

または、SupabaseダッシュボードのSQLエディタで直接実行してください。

#### マイグレーション内容

- 顧客・物件・売却詳細・購入詳細・リフォーム案件テーブル
- 原価・チェックリスト・書類・通知テーブル
- 媒介期限自動補完のトリガー
- パフォーマンス用インデックス
- RLS（Row Level Security）ポリシー

### 3. Vercel Cron設定

本番環境で定期実行タスクを設定してください：

#### 日次運用タスク（09:00 JST）
```bash
# Vercel Cron設定
0 0 * * * /api/cron/daily
```

**処理内容**:
- 媒介レポートの自動判定・送信
- 期限切れチェックリストの通知
- 媒介期限14日前のリマインド

#### 管理者エスカレーション（08:00 JST）
```bash
# Vercel Cron設定
0 23 * * * /api/cron/manager
```

**処理内容**:
- 未対応リマインダーの集計
- 担当者別の管理者へのエスカレーション通知

### 4. Seedデータの実行

サンプルデータを作成して動作確認を行います：

```bash
# TypeScriptスクリプトの実行
npx tsx scripts/seed-customers.ts
```

**作成されるデータ**:
- 売却顧客: 専属専任（メール）・専任（郵送）各1件
- 購入顧客: SUUMO・HOME'S起点各1件
- リフォーム案件: 新規・既存顧客各1件
- 原価データ・チェックリスト・期限設定済み

### 5. アプリケーションの起動

```bash
# 依存関係のインストール
npm install

# 開発サーバーの起動
npm run dev
```

## 🧪 動作確認

### 基本機能
1. **顧客作成**: `/admin/customers/new` で各カテゴリの顧客を作成
2. **一覧表示**: `/admin/customers` で全顧客・カテゴリ別表示
3. **詳細表示**: 顧客IDをクリックして詳細画面を表示

### 売却機能
1. **媒介契約**: 開始日入力で終了日が自動提案
2. **報告設定**: メール/郵送の選択（メール時はメール必須）
3. **期限管理**: 14日前リマインドの自動通知

### リフォーム機能
1. **原価入力**: 材料費・外注費・交通費・その他の入力
2. **収益分析**: 見込み売上・原価・粗利・粗利率の自動計算
3. **進捗管理**: ステータスと進捗率の更新

### チェックリスト機能
1. **自動生成**: 顧客作成時にカテゴリ別チェックリストを自動作成
2. **進捗管理**: 各項目のチェック状況を管理
3. **期限管理**: 期日超過時の自動通知

## 🔧 技術仕様

### フロントエンド
- **フレームワーク**: Next.js 15.4.6 (App Router)
- **言語**: TypeScript
- **スタイリング**: Tailwind CSS
- **状態管理**: React Hooks
- **フォーム**: React Hook Form + Zod

### バックエンド
- **API**: Next.js API Routes
- **データベース**: Supabase (PostgreSQL)
- **認証**: Clerk
- **メール**: Resend
- **PDF**: @react-pdf/renderer

### データベース
- **PostgreSQL**: Supabase上で動作
- **RLS**: 行レベルセキュリティ
- **トリガー**: 媒介期限の自動補完
- **インデックス**: パフォーマンス最適化

## 📁 ファイル構成

```
app/
├── admin/customers/          # 顧客管理画面
│   ├── page.tsx             # 一覧画面
│   ├── new/page.tsx         # 新規作成
│   └── [id]/page.tsx        # 詳細画面
├── api/
│   ├── customers/           # 顧客API
│   └── cron/                # 定期実行タスク
components/
├── customers/                # 顧客関連コンポーネント
│   ├── CustomerForm.tsx     # 顧客作成・編集フォーム
│   ├── ReformCostCard.tsx   # 原価管理カード
│   └── SellerBadge.tsx      # 売却種別バッジ
└── ui/                      # 共通UIコンポーネント
server/
└── actions/                 # サーバーアクション
    └── customers.ts         # 顧客管理ロジック
lib/
├── zod-schemas.ts           # Zodスキーマ
├── supabase-server.ts       # Supabaseクライアント
└── date-jst.ts              # JST時刻変換
supabase/
└── migrations/              # データベースマイグレーション
scripts/
└── seed-customers.ts        # サンプルデータ作成
```

## 🔐 セキュリティ

### RLS（Row Level Security）
- **管理者**: 全件の読み書き権限
- **スタッフ**: 担当顧客のみ読み書き、他は読み取りのみ
- **顧客データ**: 必要最小限の表示

### 認証・認可
- **Clerk**: ユーザー認証・セッション管理
- **権限管理**: ロールベースのアクセス制御
- **API保護**: 認証済みユーザーのみアクセス可能

## 📊 KPI・レポート

### ヘッダーカード
- **今月媒介取得数**: 新規売却案件の件数
- **報告達成率**: 要報告件数に対する報告済み件数の割合
- **期日超過件数**: 期限切れチェックリストの件数
- **リフォーム見込み粗利合計**: 全リフォーム案件の粗利合計

### 自動計算
- **媒介期限**: 開始日 + 3ヶ月 - 1日
- **粗利率**: (見込み売上 - 原価合計) / 見込み売上 × 100
- **進捗率**: チェックリスト完了項目 / 全項目 × 100

## 🚨 運用・監視

### 定期実行タスク
- **09:00 JST**: 日次運用タスク（媒介レポート・期限管理）
- **08:00 JST**: 管理者エスカレーション（未対応案件の集計）

### 通知・アラート
- **媒介レポート**: 種別に応じた自動送信
- **期限リマインド**: 14日前・当日の自動通知
- **エスカレーション**: 未対応案件の管理者通知

### ログ・監査
- **アクティビティログ**: 顧客作成・更新・削除の記録
- **エラーログ**: API実行時のエラー詳細
- **パフォーマンス**: データベースクエリの実行時間

## 🔄 今後の拡張予定

### 短期（1-3ヶ月）
- **CTI連携**: 電話番号での顧客検索・自動表示
- **ポータル連携**: 顧客向け進捗確認サイト
- **OCR機能**: 請求書・PDFからの自動データ抽出

### 中期（3-6ヶ月）
- **AI分析**: 顧客行動パターンの分析・予測
- **自動提案**: 最適な物件・サービスの自動提案
- **統合ダッシュボード**: 全システムの統合表示

### 長期（6ヶ月以上）
- **モバイルアプリ**: iOS/Androidアプリの開発
- **API連携**: 他システムとの連携・データ連携
- **多言語対応**: 英語・中国語等の多言語サポート

## 📞 サポート・問い合わせ

### 技術サポート
- **開発者**: センチュリー21ホームマート開発チーム
- **連絡先**: dev@homemart.co.jp
- **ドキュメント**: 本README + 各機能の詳細仕様書

### 運用サポート
- **管理者**: 乾代表
- **連絡先**: kan@homemart.co.jp
- **サポート時間**: 平日 9:00-18:00 JST

---

**センチュリー21ホームマート** - 不動産管理の未来を創造する
