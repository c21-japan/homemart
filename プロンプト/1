äº†è§£ã—ã¾ã—ãŸ!Cursor/Codexã«æ¸¡ã™å®Œå…¨ãªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚

---

## **ğŸ“‹ Cursor/Codexç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ(å®Œæˆç‰ˆ)**

```markdown
# ãƒãƒ©ã‚·ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ å®Ÿè£…æŒ‡ç¤ºæ›¸

## æ¦‚è¦
Next.js + Supabase + TypeScriptã§æ§‹ç¯‰ã•ã‚ŒãŸæ—¢å­˜ã®ä¸å‹•ç”£ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã«ã€ãƒãƒ©ã‚·é…å¸ƒãƒ»å•ã„åˆã‚ã›è¿½è·¡ãƒ»AIåˆ†ææ©Ÿèƒ½ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚

## æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯
- Next.js 15.4.6
- React + TypeScript
- Supabase (PostgreSQL)
- Clerkèªè¨¼
- Tailwind CSS
- Vercel ãƒ‡ãƒ—ãƒ­ã‚¤

## å®Ÿè£…å†…å®¹

### 1. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ (database-flyers.sql)

ä»¥ä¸‹ã®SQLãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¦ãã ã•ã„:

```sql
-- ==================================================
-- ãƒãƒ©ã‚·ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ 
-- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒå®šç¾©
-- ==================================================

-- UUIDæ‹¡å¼µæœ‰åŠ¹åŒ–(æ—¢ã«æœ‰åŠ¹ãªå ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—)
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

-- ==================================================
-- 1. ãƒãƒ©ã‚·ãƒ‡ã‚¶ã‚¤ãƒ³ç®¡ç†ãƒ†ãƒ¼ãƒ–ãƒ«
-- ==================================================
CREATE TABLE IF NOT EXISTS flyer_designs (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  design_id VARCHAR(50) UNIQUE NOT NULL,
  design_name VARCHAR(200) NOT NULL,
  design_image_url TEXT,
  designer_name VARCHAR(100),
  designer_source VARCHAR(50) CHECK (designer_source IN ('crowdworks', 'internal', 'ai-generated', 'other')),
  appeal_point TEXT,
  adopted_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  start_date DATE,
  end_date DATE,
  total_distributed INTEGER DEFAULT 0,
  total_inquiries INTEGER DEFAULT 0,
  response_rate DECIMAL(5,2) GENERATED ALWAYS AS (
    CASE 
      WHEN total_distributed > 0 
      THEN ROUND((total_inquiries::DECIMAL / total_distributed) * 100, 2)
      ELSE 0 
    END
  ) STORED,
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX idx_flyer_designs_active ON flyer_designs(is_active) WHERE is_active = true;
CREATE INDEX idx_flyer_designs_dates ON flyer_designs(start_date, end_date);

-- æ›´æ–°æ—¥æ™‚è‡ªå‹•æ›´æ–°ãƒˆãƒªã‚¬ãƒ¼
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER update_flyer_designs_updated_at
  BEFORE UPDATE ON flyer_designs
  FOR EACH ROW
  EXECUTE FUNCTION update_updated_at_column();

-- ==================================================
-- 2. ãƒãƒ©ã‚·é…å¸ƒè¨˜éŒ²ãƒ†ãƒ¼ãƒ–ãƒ«
-- ==================================================
CREATE TABLE IF NOT EXISTS flyer_distributions (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  distribution_date DATE NOT NULL,
  design_id VARCHAR(50) NOT NULL,
  area VARCHAR(200) NOT NULL,
  quantity INTEGER NOT NULL CHECK (quantity > 0),
  distributor_name VARCHAR(100),
  print_date DATE,
  print_quantity INTEGER CHECK (print_quantity > 0),
  notes TEXT,
  created_by UUID,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  CONSTRAINT fk_design FOREIGN KEY (design_id) REFERENCES flyer_designs(design_id) ON DELETE CASCADE
);

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX idx_distributions_date ON flyer_distributions(distribution_date DESC);
CREATE INDEX idx_distributions_design ON flyer_distributions(design_id);
CREATE INDEX idx_distributions_area ON flyer_distributions(area);

CREATE TRIGGER update_flyer_distributions_updated_at
  BEFORE UPDATE ON flyer_distributions
  FOR EACH ROW
  EXECUTE FUNCTION update_updated_at_column();

-- ==================================================
-- 3. å•ã„åˆã‚ã›è¨˜éŒ²ãƒ†ãƒ¼ãƒ–ãƒ«
-- ==================================================
CREATE TABLE IF NOT EXISTS flyer_inquiries (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  inquiry_datetime TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  inquiry_channel VARCHAR(50) NOT NULL CHECK (inquiry_channel IN ('phone', 'line', 'web', 'visit', 'other')),
  inquiry_type VARCHAR(100) NOT NULL,
  design_id VARCHAR(50),
  distribution_area VARCHAR(200),
  lead_id UUID,
  conversion_possibility VARCHAR(20) CHECK (conversion_possibility IN ('high', 'medium', 'low')),
  handler_name VARCHAR(100),
  notes TEXT,
  created_by UUID,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  CONSTRAINT fk_design_inquiry FOREIGN KEY (design_id) REFERENCES flyer_designs(design_id) ON DELETE SET NULL
);

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX idx_inquiries_datetime ON flyer_inquiries(inquiry_datetime DESC);
CREATE INDEX idx_inquiries_design ON flyer_inquiries(design_id);
CREATE INDEX idx_inquiries_area ON flyer_inquiries(distribution_area);
CREATE INDEX idx_inquiries_channel ON flyer_inquiries(inquiry_channel);

CREATE TRIGGER update_flyer_inquiries_updated_at
  BEFORE UPDATE ON flyer_inquiries
  FOR EACH ROW
  EXECUTE FUNCTION update_updated_at_column();

-- ==================================================
-- 4. AIåˆ†æçµæœä¿å­˜ãƒ†ãƒ¼ãƒ–ãƒ«
-- ==================================================
CREATE TABLE IF NOT EXISTS flyer_ai_analysis (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  analysis_week DATE NOT NULL UNIQUE,
  week_start DATE NOT NULL,
  week_end DATE NOT NULL,
  total_distributed INTEGER DEFAULT 0,
  total_inquiries INTEGER DEFAULT 0,
  overall_response_rate DECIMAL(5,2),
  top_performing_designs JSONB,
  top_performing_areas JSONB,
  recommendations TEXT,
  next_week_schedule JSONB,
  analysis_data JSONB,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX idx_ai_analysis_week ON flyer_ai_analysis(analysis_week DESC);

-- ==================================================
-- 5. ãƒ“ãƒ¥ãƒ¼: é€±æ¬¡ã‚µãƒãƒªãƒ¼
-- ==================================================
CREATE OR REPLACE VIEW flyer_weekly_summary AS
SELECT 
  DATE_TRUNC('week', distribution_date) AS week_start,
  COUNT(DISTINCT id) AS distribution_count,
  SUM(quantity) AS total_distributed,
  COUNT(DISTINCT design_id) AS unique_designs,
  COUNT(DISTINCT area) AS unique_areas
FROM flyer_distributions
GROUP BY DATE_TRUNC('week', distribution_date)
ORDER BY week_start DESC;

-- ==================================================
-- 6. ãƒ“ãƒ¥ãƒ¼: ãƒ‡ã‚¶ã‚¤ãƒ³åˆ¥ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹
-- ==================================================
CREATE OR REPLACE VIEW flyer_design_performance AS
SELECT 
  fd.design_id,
  fd.design_name,
  fd.total_distributed,
  fd.total_inquiries,
  fd.response_rate,
  COUNT(DISTINCT dist.area) AS areas_distributed,
  MAX(dist.distribution_date) AS last_distribution_date
FROM flyer_designs fd
LEFT JOIN flyer_distributions dist ON fd.design_id = dist.design_id
WHERE fd.is_active = true
GROUP BY fd.design_id, fd.design_name, fd.total_distributed, fd.total_inquiries, fd.response_rate
ORDER BY fd.response_rate DESC;

-- ==================================================
-- 7. ãƒ“ãƒ¥ãƒ¼: ã‚¨ãƒªã‚¢åˆ¥ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹
-- ==================================================
CREATE OR REPLACE VIEW flyer_area_performance AS
SELECT 
  dist.area,
  SUM(dist.quantity) AS total_distributed,
  COUNT(DISTINCT inq.id) AS total_inquiries,
  CASE 
    WHEN SUM(dist.quantity) > 0 
    THEN ROUND((COUNT(DISTINCT inq.id)::DECIMAL / SUM(dist.quantity)) * 100, 2)
    ELSE 0 
  END AS response_rate,
  COUNT(DISTINCT dist.design_id) AS unique_designs_used
FROM flyer_distributions dist
LEFT JOIN flyer_inquiries inq ON dist.area = inq.distribution_area
GROUP BY dist.area
ORDER BY response_rate DESC;

-- ==================================================
-- 8. é…å¸ƒè¨˜éŒ²ä½œæˆæ™‚ã®ãƒ‡ã‚¶ã‚¤ãƒ³é›†è¨ˆæ›´æ–°ãƒˆãƒªã‚¬ãƒ¼
-- ==================================================
CREATE OR REPLACE FUNCTION update_design_statistics()
RETURNS TRIGGER AS $$
BEGIN
  -- é…å¸ƒæšæ•°ã‚’æ›´æ–°
  IF TG_OP = 'INSERT' THEN
    UPDATE flyer_designs
    SET total_distributed = total_distributed + NEW.quantity
    WHERE design_id = NEW.design_id;
  ELSIF TG_OP = 'UPDATE' THEN
    UPDATE flyer_designs
    SET total_distributed = total_distributed - OLD.quantity + NEW.quantity
    WHERE design_id = NEW.design_id;
  ELSIF TG_OP = 'DELETE' THEN
    UPDATE flyer_designs
    SET total_distributed = total_distributed - OLD.quantity
    WHERE design_id = OLD.design_id;
  END IF;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_update_design_statistics
  AFTER INSERT OR UPDATE OR DELETE ON flyer_distributions
  FOR EACH ROW
  EXECUTE FUNCTION update_design_statistics();

-- ==================================================
-- 9. å•ã„åˆã‚ã›è¨˜éŒ²æ™‚ã®ãƒ‡ã‚¶ã‚¤ãƒ³é›†è¨ˆæ›´æ–°ãƒˆãƒªã‚¬ãƒ¼
-- ==================================================
CREATE OR REPLACE FUNCTION update_inquiry_statistics()
RETURNS TRIGGER AS $$
BEGIN
  IF TG_OP = 'INSERT' AND NEW.design_id IS NOT NULL THEN
    UPDATE flyer_designs
    SET total_inquiries = total_inquiries + 1
    WHERE design_id = NEW.design_id;
  ELSIF TG_OP = 'DELETE' AND OLD.design_id IS NOT NULL THEN
    UPDATE flyer_designs
    SET total_inquiries = total_inquiries - 1
    WHERE design_id = OLD.design_id;
  ELSIF TG_OP = 'UPDATE' THEN
    IF OLD.design_id IS NOT NULL THEN
      UPDATE flyer_designs
      SET total_inquiries = total_inquiries - 1
      WHERE design_id = OLD.design_id;
    END IF;
    IF NEW.design_id IS NOT NULL THEN
      UPDATE flyer_designs
      SET total_inquiries = total_inquiries + 1
      WHERE design_id = NEW.design_id;
    END IF;
  END IF;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_update_inquiry_statistics
  AFTER INSERT OR UPDATE OR DELETE ON flyer_inquiries
  FOR EACH ROW
  EXECUTE FUNCTION update_inquiry_statistics();

-- ==================================================
-- 10. Row Level Security (RLS) ãƒãƒªã‚·ãƒ¼
-- ==================================================

-- flyer_designs
ALTER TABLE flyer_designs ENABLE ROW LEVEL SECURITY;

CREATE POLICY "å…¨å“¡ãŒé–²è¦§å¯èƒ½" ON flyer_designs
  FOR SELECT USING (true);

CREATE POLICY "èªè¨¼ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒä½œæˆå¯èƒ½" ON flyer_designs
  FOR INSERT WITH CHECK (auth.role() = 'authenticated');

CREATE POLICY "èªè¨¼ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ›´æ–°å¯èƒ½" ON flyer_designs
  FOR UPDATE USING (auth.role() = 'authenticated');

-- flyer_distributions
ALTER TABLE flyer_distributions ENABLE ROW LEVEL SECURITY;

CREATE POLICY "å…¨å“¡ãŒé–²è¦§å¯èƒ½" ON flyer_distributions
  FOR SELECT USING (true);

CREATE POLICY "èªè¨¼ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒä½œæˆå¯èƒ½" ON flyer_distributions
  FOR INSERT WITH CHECK (auth.role() = 'authenticated');

CREATE POLICY "èªè¨¼ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ›´æ–°å¯èƒ½" ON flyer_distributions
  FOR UPDATE USING (auth.role() = 'authenticated');

-- flyer_inquiries
ALTER TABLE flyer_inquiries ENABLE ROW LEVEL SECURITY;

CREATE POLICY "å…¨å“¡ãŒé–²è¦§å¯èƒ½" ON flyer_inquiries
  FOR SELECT USING (true);

CREATE POLICY "èªè¨¼ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒä½œæˆå¯èƒ½" ON flyer_inquiries
  FOR INSERT WITH CHECK (auth.role() = 'authenticated');

CREATE POLICY "èªè¨¼ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ›´æ–°å¯èƒ½" ON flyer_inquiries
  FOR UPDATE USING (auth.role() = 'authenticated');

-- flyer_ai_analysis
ALTER TABLE flyer_ai_analysis ENABLE ROW LEVEL SECURITY;

CREATE POLICY "å…¨å“¡ãŒé–²è¦§å¯èƒ½" ON flyer_ai_analysis
  FOR SELECT USING (true);

CREATE POLICY "èªè¨¼ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒä½œæˆå¯èƒ½" ON flyer_ai_analysis
  FOR INSERT WITH CHECK (auth.role() = 'authenticated');

-- ==================================================
-- 11. ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿æŒ¿å…¥
-- ==================================================

-- ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ã‚¶ã‚¤ãƒ³
INSERT INTO flyer_designs (design_id, design_name, designer_source, appeal_point, is_active) VALUES
('design-001', 'è²·å–å¼·åŒ–ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³_èµ¤', 'internal', 'é«˜é¡è²·å–ã‚’å¼·èª¿ã€èµ¤ç³»ã§ç›®ç«‹ã¤ãƒ‡ã‚¶ã‚¤ãƒ³', true),
('design-002', 'ãƒªãƒ•ã‚©ãƒ¼ãƒ ç›¸è«‡_é’', 'internal', 'ãƒªãƒ•ã‚©ãƒ¼ãƒ äº‹ä¾‹å†™çœŸæ²è¼‰ã€ä¿¡é ¼æ„Ÿã®ã‚ã‚‹é’ç³»', true),
('design-003', 'åœ°åŸŸå¯†ç€_ç·‘', 'internal', 'åœ°åŸŸå®Ÿç¸¾ã‚’å¼·èª¿ã€è¦ªã—ã¿ã‚„ã™ã„ç·‘ç³»', true)
ON CONFLICT (design_id) DO NOTHING;

-- å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
DO $$
BEGIN
  RAISE NOTICE 'ãƒãƒ©ã‚·ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ§‹ç¯‰ãŒå®Œäº†ã—ã¾ã—ãŸ';
END $$;
```

### 2. TypeScriptå‹å®šç¾© (types/flyers.ts)

```typescript
// types/flyers.ts
export interface FlyerDesign {
  id: string;
  design_id: string;
  design_name: string;
  design_image_url?: string;
  designer_name?: string;
  designer_source?: 'crowdworks' | 'internal' | 'ai-generated' | 'other';
  appeal_point?: string;
  adopted_at?: string;
  start_date?: string;
  end_date?: string;
  total_distributed: number;
  total_inquiries: number;
  response_rate?: number;
  is_active: boolean;
  created_at: string;
  updated_at: string;
}

export interface FlyerDistribution {
  id: string;
  distribution_date: string;
  design_id: string;
  area: string;
  quantity: number;
  distributor_name?: string;
  print_date?: string;
  print_quantity?: number;
  notes?: string;
  created_by?: string;
  created_at: string;
  updated_at: string;
}

export interface FlyerInquiry {
  id: string;
  inquiry_datetime: string;
  inquiry_channel: 'phone' | 'line' | 'web' | 'visit' | 'other';
  inquiry_type: string;
  design_id?: string;
  distribution_area?: string;
  lead_id?: string;
  conversion_possibility?: 'high' | 'medium' | 'low';
  handler_name?: string;
  notes?: string;
  created_by?: string;
  created_at: string;
  updated_at: string;
}

export interface FlyerAIAnalysis {
  id: string;
  analysis_week: string;
  week_start: string;
  week_end: string;
  total_distributed: number;
  total_inquiries: number;
  overall_response_rate?: number;
  top_performing_designs?: any;
  top_performing_areas?: any;
  recommendations?: string;
  next_week_schedule?: any;
  analysis_data?: any;
  created_at: string;
}

export interface WeeklySummary {
  week_start: string;
  distribution_count: number;
  total_distributed: number;
  unique_designs: number;
  unique_areas: number;
}

export interface DesignPerformance {
  design_id: string;
  design_name: string;
  total_distributed: number;
  total_inquiries: number;
  response_rate: number;
  areas_distributed: number;
  last_distribution_date: string;
}

export interface AreaPerformance {
  area: string;
  total_distributed: number;
  total_inquiries: number;
  response_rate: number;
  unique_designs_used: number;
}
```

### 3. Server Actions (server/actions/flyers.ts)

æ—¢å­˜ã®`server/actions/`ãƒ‘ã‚¿ãƒ¼ãƒ³ã«å¾“ã£ã¦ã€ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¦ãã ã•ã„:

```typescript
// server/actions/flyers.ts
'use server';

import { createClient } from '@/lib/supabase-server';
import { revalidatePath } from 'next/cache';
import type { 
  FlyerDesign, 
  FlyerDistribution, 
  FlyerInquiry,
  DesignPerformance,
  AreaPerformance 
} from '@/types/flyers';

// ==================================================
// ãƒ‡ã‚¶ã‚¤ãƒ³ç®¡ç†
// ==================================================

export async function createFlyerDesign(data: Partial<FlyerDesign>) {
  const supabase = createClient();
  
  const { data: design, error } = await supabase
    .from('flyer_designs')
    .insert(data)
    .select()
    .single();

  if (error) throw error;
  
  revalidatePath('/admin/flyers/designs');
  return design;
}

export async function getFlyerDesigns(activeOnly: boolean = true) {
  const supabase = createClient();
  
  let query = supabase
    .from('flyer_designs')
    .select('*')
    .order('created_at', { ascending: false });

  if (activeOnly) {
    query = query.eq('is_active', true);
  }

  const { data, error } = await query;
  if (error) throw error;
  return data as FlyerDesign[];
}

export async function updateFlyerDesign(id: string, data: Partial<FlyerDesign>) {
  const supabase = createClient();
  
  const { data: design, error } = await supabase
    .from('flyer_designs')
    .update(data)
    .eq('id', id)
    .select()
    .single();

  if (error) throw error;
  
  revalidatePath('/admin/flyers/designs');
  return design;
}

// ==================================================
// é…å¸ƒè¨˜éŒ²
// ==================================================

export async function createDistribution(data: Partial<FlyerDistribution>) {
  const supabase = createClient();
  
  const { data: distribution, error } = await supabase
    .from('flyer_distributions')
    .insert(data)
    .select()
    .single();

  if (error) throw error;
  
  revalidatePath('/admin/flyers/distributions');
  return distribution;
}

export async function getDistributions(filters?: {
  startDate?: string;
  endDate?: string;
  designId?: string;
  area?: string;
}) {
  const supabase = createClient();
  
  let query = supabase
    .from('flyer_distributions')
    .select('*, flyer_designs(*)')
    .order('distribution_date', { ascending: false });

  if (filters?.startDate) {
    query = query.gte('distribution_date', filters.startDate);
  }
  if (filters?.endDate) {
    query = query.lte('distribution_date', filters.endDate);
  }
  if (filters?.designId) {
    query = query.eq('design_id', filters.designId);
  }
  if (filters?.area) {
    query = query.eq('area', filters.area);
  }

  const { data, error } = await query;
  if (error) throw error;
  return data;
}

// ==================================================
// å•ã„åˆã‚ã›è¨˜éŒ²
// ==================================================

export async function createInquiry(data: Partial<FlyerInquiry>) {
  const supabase = createClient();
  
  const { data: inquiry, error } = await supabase
    .from('flyer_inquiries')
    .insert(data)
    .select()
    .single();

  if (error) throw error;
  
  revalidatePath('/admin/flyers/inquiries');
  return inquiry;
}

export async function getInquiries(filters?: {
  startDate?: string;
  endDate?: string;
  designId?: string;
  area?: string;
  channel?: string;
}) {
  const supabase = createClient();
  
  let query = supabase
    .from('flyer_inquiries')
    .select('*, flyer_designs(*)')
    .order('inquiry_datetime', { ascending: false });

  if (filters?.startDate) {
    query = query.gte('inquiry_datetime', filters.startDate);
  }
  if (filters?.endDate) {
    query = query.lte('inquiry_datetime', filters.endDate);
  }
  if (filters?.designId) {
    query = query.eq('design_id', filters.designId);
  }
  if (filters?.area) {
    query = query.eq('distribution_area', filters.area);
  }
  if (filters?.channel) {
    query = query.eq('inquiry_channel', filters.channel);
  }

  const { data, error } = await query;
  if (error) throw error;
  return data;
}

// ==================================================
// ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹åˆ†æ
// ==================================================

export async function getDesignPerformance() {
  const supabase = createClient();
  
  const { data, error } = await supabase
    .from('flyer_design_performance')
    .select('*');

  if (error) throw error;
  return data as DesignPerformance[];
}

export async function getAreaPerformance() {
  const supabase = createClient();
  
  const { data, error } = await supabase
    .from('flyer_area_performance')
    .select('*');

  if (error) throw error;
  return data as AreaPerformance[];
}

export async function getWeeklySummary(weekStart?: string) {
  const supabase = createClient();
  
  let query = supabase
    .from('flyer_weekly_summary')
    .select('*');

  if (weekStart) {
    query = query.eq('week_start', weekStart);
  }

  const { data, error } = await query;
  if (error) throw error;
  return data;
}

// ==================================================
// AIåˆ†æçµæœ
// ==================================================

export async function getAIAnalysis(weekStart?: string) {
  const supabase = createClient();
  
  let query = supabase
    .from('flyer_ai_analysis')
    .select('*')
    .order('analysis_week', { ascending: false });

  if (weekStart) {
    query = query.eq('analysis_week', weekStart).single();
  } else {
    query = query.limit(1);
  }

  const { data, error } = await query;
  if (error && error.code !== 'PGRST116') throw error;
  return weekStart ? data : (data as any[])?.[0];
}

export async function saveAIAnalysis(analysisData: Partial<FlyerAIAnalysis>) {
  const supabase = createClient();
  
  const { data, error } = await supabase
    .from('flyer_ai_analysis')
    .upsert(analysisData, {
      onConflict: 'analysis_week'
    })
    .select()
    .single();

  if (error) throw error;
  
  revalidatePath('/admin/flyers/analysis');
  return data;
}

// ==================================================
// ã‚¨ãƒªã‚¢ä¸€è¦§å–å¾—(ãƒ¦ãƒ‹ãƒ¼ã‚¯)
// ==================================================

export async function getUniqueAreas() {
  const supabase = createClient();
  
  const { data, error } = await supabase
    .from('flyer_distributions')
    .select('area')
    .order('area');

  if (error) throw error;
  
  const uniqueAreas = [...new Set(data.map(d => d.area))];
  return uniqueAreas;
}
```

### 4. ç®¡ç†ç”»é¢ãƒšãƒ¼ã‚¸

#### 4-1. ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ (app/admin/flyers/page.tsx)

```typescript
// app/admin/flyers/page.tsx
import { Suspense } from 'react';
import Link from 'next/link';
import { 
  getDesignPerformance, 
  getAreaPerformance,
  getWeeklySummary,
  getAIAnalysis 
} from '@/server/actions/flyers';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { 
  TrendingUp, 
  MapPin, 
  Calendar, 
  BarChart3,
  FileText,
  MessageSquare,
  Palette
} from 'lucide-react';

export default async function FlyersDashboardPage() {
  const [designPerf, areaPerf, weeklySummary, aiAnalysis] = await Promise.all([
    getDesignPerformance(),
    getAreaPerformance(),
    getWeeklySummary(),
    getAIAnalysis()
  ]);

  const currentWeek = weeklySummary?.[0];

  return (
    <div className="container mx-auto p-6 space-y-6">
      <div className="flex justify-between items-center">
        <h1 className="text-3xl font-bold">ãƒãƒ©ã‚·ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°åˆ†æ</h1>
        <div className="flex gap-2">
          <Link href="/admin/flyers/distributions/new">
            <Button>
              <FileText className="mr-2 h-4 w-4" />
              é…å¸ƒè¨˜éŒ²ç™»éŒ²
            </Button>
          </Link>
          <Link href="/admin/flyers/inquiries/new">
            <Button variant="outline">
              <MessageSquare className="mr-2 h-4 w-4" />
              å•ã„åˆã‚ã›ç™»éŒ²
            </Button>
          </Link>
        </div>
      </div>

      {/* ä»Šé€±ã®ã‚µãƒãƒªãƒ¼ */}
      <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">ä»Šé€±ã®é…å¸ƒæšæ•°</CardTitle>
            <FileText className="h-4 w-4 text-muted-foreground" />
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">
              {currentWeek?.total_distributed.toLocaleString()}æš
            </div>
          </CardContent>
        </Card>

        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">é…å¸ƒå›æ•°</CardTitle>
            <Calendar className="h-4 w-4 text-muted-foreground" />
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">
              {currentWeek?.distribution_count}å›
            </div>
          </CardContent>
        </Card>

        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">ä½¿ç”¨ãƒ‡ã‚¶ã‚¤ãƒ³æ•°</CardTitle>
            <Palette className="h-4 w-4 text-muted-foreground" />
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">
              {currentWeek?.unique_designs}ç¨®é¡
            </div>
          </CardContent>
        </Card>

        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">é…å¸ƒã‚¨ãƒªã‚¢æ•°</CardTitle>
            <MapPin className="h-4 w-4 text-muted-foreground" />
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">
              {currentWeek?.unique_areas}åœ°åŸŸ
            </div>
          </CardContent>
        </Card>
      </div>

      {/* ãƒ‡ã‚¶ã‚¤ãƒ³åˆ¥ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ */}
      <Card>
        <CardHeader>
          <CardTitle className="flex items-center gap-2">
            <TrendingUp className="h-5 w-5" />
            ãƒ‡ã‚¶ã‚¤ãƒ³åˆ¥åå¿œç‡ãƒ©ãƒ³ã‚­ãƒ³ã‚°
          </CardTitle>
        </CardHeader>
        <CardContent>
          <div className="space-y-4">
            {designPerf.slice(0, 5).map((design, index) => (
              <div key={design.design_id} className="flex items-center justify-between">
                <div className="flex items-center gap-3">
                  <div className="flex items-center justify-center w-8 h-8 rounded-full bg-primary text-primary-foreground font-bold">
                    {index + 1}
                  </div>
                  <div>
                    <p className="font-medium">{design.design_name}</p>
                    <p className="text-sm text-muted-foreground">
                      {design.total_distributed.toLocaleString()}æš â†’ {design.total_inquiries}ä»¶
                    </p>
                  </div>
                </div>
                <div className="text-right">
                  <p className="text-2xl font-bold text-green-600">
                    {design.response_rate.toFixed(2)}%
                  </p>
                  <p className="text-sm text-muted-foreground">
                    {design.areas_distributed}ã‚¨ãƒªã‚¢ã§é…å¸ƒ
                  </p>
                </div>
              </div>
            ))}
          </div>
        </CardContent>
      </Card>

      {/* ã‚¨ãƒªã‚¢åˆ¥ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ */}
      <Card>
        <CardHeader>
          <CardTitle className="flex items-center gap-2">
            <MapPin className="h-5 w-5" />
            ã‚¨ãƒªã‚¢åˆ¥åå¿œç‡
          </CardTitle>
        </CardHeader>
        <CardContent>
          <div className="space-y-3">
            {areaPerf.slice(0, 5).map((area, index) => (
              <div key={area.area} className="flex items-center justify-between">
                <div className="flex items-center gap-3">
                  <span className="text-lg font-semibold text-muted-foreground">
                    {index + 1}.
                  </span>
                  <div>
                    <p className="font-medium">{area.area}</p>
                    <p className="text-sm text-muted-foreground">
                      {area.total_distributed.toLocaleString()}æš / {area.unique_designs_used}ãƒ‡ã‚¶ã‚¤ãƒ³ä½¿ç”¨
                    </p>
                  </div>
                </div>
                <div className="text-right">
                  <p className="text-xl font-bold">
                    {area.response_rate.toFixed(2)}%
                  </p>
                  <p className="text-sm text-muted-foreground">
                    {area.total_inquiries}ä»¶ã®å•ã„åˆã‚ã›
                  </p>
                </div>
              </div>
            ))}
          </div>
        </CardContent>
      </Card>

      {/* AIåˆ†æçµæœ */}
      {aiAnalysis && (
        <Card>
          <CardHeader>
            <CardTitle className="flex items-center gap-2">
              <BarChart3 className="h-5 w-5" />
              AIåˆ†æã«ã‚ˆã‚‹ææ¡ˆ
            </CardTitle>
          </CardHeader>
          <CardContent>
            <div className="prose max-w-none">
              <p className="whitespace-pre-wrap">{aiAnalysis.recommendations}</p>
            </div>
            <div className="mt-4">
              <Link href="/admin/flyers/analysis">
                <Button variant="outline">
                  è©³ç´°ãªåˆ†æãƒ¬ãƒãƒ¼ãƒˆã‚’è¦‹ã‚‹
                </Button>
              </Link>
            </div>
          </CardContent>
        </Card>
      )}

      {/* ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚»ã‚¹ */}
      <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
        <Link href="/admin/flyers/distributions">
          <Card className="hover:bg-accent cursor-pointer transition-colors">
            <CardContent className="flex items-center gap-3 p-6">
              <FileText className="h-8 w-8 text-primary" />
              <div>
                <p className="font-semibold">é…å¸ƒè¨˜éŒ²ä¸€è¦§</p>
                <p className="text-sm text-muted-foreground">éå»ã®é…å¸ƒå±¥æ­´ã‚’ç¢ºèª</p>
              </div>
            </CardContent>
          </Card>
        </Link>

        <Link href="/admin/flyers/inquiries">
          <Card className="hover:bg-accent cursor-pointer transition-colors">
            <CardContent className="flex items-center gap-3 p-6">
              <MessageSquare className="h-8 w-8 text-primary" />
              <div>
                <p className="font-semibold">å•ã„åˆã‚ã›ä¸€è¦§</p>
                <p className="text-sm text-muted-foreground">åå¿œãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèª</p>
              </div>
            </CardContent>
          </Card>
        </Link>

        <Link href="/admin/flyers/designs">
          <Card className="hover:bg-accent cursor-pointer transition-colors">
            <CardContent className="flex items-center gap-3 p-6">
              <Palette className="h-8 w-8 text-primary" />
              <div>
                <p className="font-semibold">ãƒ‡ã‚¶ã‚¤ãƒ³ç®¡ç†</p>
                <p className="text-sm text-muted-foreground">ãƒãƒ©ã‚·ãƒ‡ã‚¶ã‚¤ãƒ³ã‚’ç®¡ç†</p>
              </div>
            </CardContent>
          </Card>
        </Link>
      </div>
    </div>
  );
}
```

#### 4-2. é…å¸ƒè¨˜éŒ²ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ  (app/admin/flyers/distributions/new/page.tsx)

```typescript
// app/admin/flyers/distributions/new/page.tsx
import { DistributionForm } from '@/components/flyers/DistributionForm';
import { getFlyerDesigns, getUniqueAreas } from '@/server/actions/flyers';

export default async function NewDistributionPage() {
  const [designs, areas] = await Promise.all([
    getFlyerDesigns(true),
    getUniqueAreas()
  ]);

  return (
    <div className="container mx-auto p-6 max-w-2xl">
      <h1 className="text-3xl font-bold mb-6">ãƒãƒ©ã‚·é…å¸ƒè¨˜éŒ²ç™»éŒ²</h1>
      <DistributionForm designs={designs} existingAreas={areas} />
    </div>
  );
}
```

#### 4-3. é…å¸ƒè¨˜éŒ²ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ (components/flyers/DistributionForm.tsx)

```typescript
// components/flyers/DistributionForm.tsx
'use client';

import { useState } from 'react';
import { useRouter } from 'next/navigation';
import { createDistribution } from '@/server/actions/flyers';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Textarea } from '@/components/ui/textarea';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select';
import { toast } from 'sonner';
import type { FlyerDesign } from '@/types/flyers';

interface DistributionFormProps {
  designs: FlyerDesign[];
  existingAreas: string[];
}

export function DistributionForm({ designs, existingAreas }: DistributionFormProps) {
  const router = useRouter();
  const [isLoading, setIsLoading] = useState(false);
  const [formData, setFormData] = useState({
    distribution_date: new Date().toISOString().split('T')[0],
    design_id: '',
    area: '',
    quantity: '',
    distributor_name: '',
    print_date: '',
    print_quantity: '',
    notes: ''
  });

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setIsLoading(true);

    try {
      await createDistribution({
        distribution_date: formData.distribution_date,
        design_id: formData.design_id,
        area: formData.area,
        quantity: parseInt(formData.quantity),
        distributor_name: formData.distributor_name || undefined,
        print_date: formData.print_date || undefined,
        print_quantity: formData.print_quantity ? parseInt(formData.print_quantity) : undefined,
        notes: formData.notes || undefined
      });

      toast.success('é…å¸ƒè¨˜éŒ²ã‚’ç™»éŒ²ã—ã¾ã—ãŸ');
      router.push('/admin/flyers/distributions');
      router.refresh();
    } catch (error) {
      console.error(error);
      toast.error('ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ');
    } finally {
      setIsLoading(false);
    }
  };

  const handleChange = (field: string, value: string) => {
    setFormData(prev => ({ ...prev, [field]: value }));
  };

  return (
    <form onSubmit={handleSubmit} className="space-y-6">
      <div className="space-y-2">
        <Label htmlFor="distribution_date">é…å¸ƒæ—¥ *</Label>
        <Input
          id="distribution_date"
          type="date"
          value={formData.distribution_date}
          onChange={(e) => handleChange('distribution_date', e.target.value)}
          required
        />
      </div>

      <div className="space-y-2">
        <Label htmlFor="design_id">ãƒãƒ©ã‚·ãƒ‡ã‚¶ã‚¤ãƒ³ *</Label>
        <Select
          value={formData.design_id}
          onValueChange={(value) => handleChange('design_id', value)}
          required
        >
          <SelectTrigger>
            <SelectValue placeholder="ãƒ‡ã‚¶ã‚¤ãƒ³ã‚’é¸æŠ" />
          </SelectTrigger>
          <SelectContent>
            {designs.map((design) => (
              <SelectItem key={design.design_id} value={design.design_id}>
                {design.design_name}
              </SelectItem>
            ))}
          </SelectContent>
        </Select>
      </div>

      <div className="space-y-2">
        <Label htmlFor="area">é…å¸ƒã‚¨ãƒªã‚¢ *</Label>
        <Select
          value={formData.area}
          onValueChange={(value) => handleChange('area', value)}
          required
        >
          <SelectTrigger>
            <SelectValue placeholder="ã‚¨ãƒªã‚¢ã‚’é¸æŠã¾ãŸã¯æ–°è¦å…¥åŠ›" />
          </SelectTrigger>
          <SelectContent>
            <SelectItem value="åºƒé™µç”ºç¬ ">åºƒé™µç”ºç¬ </SelectItem>
            <SelectItem value="åºƒé™µç”ºç™¾æ¸ˆ">åºƒé™µç”ºç™¾æ¸ˆ</SelectItem>
            <SelectItem value="åºƒé™µç”ºå¤å¯º">åºƒé™µç”ºå¤å¯º</SelectItem>
            <SelectItem value="åºƒé™µç”ºå—éƒ·">åºƒé™µç”ºå—éƒ·</SelectItem>
            {existingAreas.filter(a => !['åºƒé™µç”ºç¬ ', 'åºƒé™µç”ºç™¾æ¸ˆ', 'åºƒé™µç”ºå¤å¯º', 'åºƒé™µç”ºå—éƒ·'].includes(a)).map(area => (
              <SelectItem key={area} value={area}>{area}</SelectItem>
            ))}
          </SelectContent>
        </Select>
        <Input
          placeholder="ã¾ãŸã¯æ–°ã—ã„ã‚¨ãƒªã‚¢åã‚’å…¥åŠ›"
          value={formData.area}
          onChange={(e) => handleChange('area', e.target.value)}
        />
      </div>

      <div className="space-y-2">
        <Label htmlFor="quantity">é…å¸ƒæšæ•° *</Label>
        <Input
          id="quantity"
          type="number"
          min="1"
          value={formData.quantity}
          onChange={(e) => handleChange('quantity', e.target.value)}
          placeholder="ä¾‹: 500"
          required
        />
      </div>

      <div className="space-y-2">
        <Label htmlFor="distributor_name">é…å¸ƒæ‹…å½“è€…</Label>
        <Input
          id="distributor_name"
          value={formData.distributor_name}
          onChange={(e) => handleChange('distributor_name', e.target.value)}
          placeholder="ä¾‹: ä»Šæ´¥"
        />
      </div>

      <div className="grid grid-cols-2 gap-4">
        <div className="space-y-2">
          <Label htmlFor="print_date">å°åˆ·æ—¥</Label>
          <Input
            id="print_date"
            type="date"
            value={formData.print_date}
            onChange={(e) => handleChange('print_date', e.target.value)}
          />
        </div>

        <div className="space-y-2">
          <Label htmlFor="print_quantity">å°åˆ·æšæ•°</Label>
          <Input
            id="print_quantity"
            type="number"
            min="1"
            value={formData.print_quantity}
            onChange={(e) => handleChange('print_quantity', e.target.value)}
            placeholder="ä¾‹: 1000"
          />
        </div>
      </div>

      <div className="space-y-2">
        <Label htmlFor="notes">å‚™è€ƒ</Label>
        <Textarea
          id="notes"
          value={formData.notes}
          onChange={(e) => handleChange('notes', e.target.value)}
          placeholder="ç‰¹è¨˜äº‹é …ãŒã‚ã‚Œã°å…¥åŠ›ã—ã¦ãã ã•ã„"
          rows={3}
        />
      </div>

      <div className="flex gap-3">
        <Button type="submit" disabled={isLoading}>
          {isLoading ? 'ç™»éŒ²ä¸­...' : 'ç™»éŒ²ã™ã‚‹'}
        </Button>
        <Button
          type="button"
          variant="outline"
          onClick={() => router.back()}
        >
          ã‚­ãƒ£ãƒ³ã‚»ãƒ«
        </Button>
      </div>
    </form>
  );
}
```

#### 4-4. å•ã„åˆã‚ã›ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ (components/flyers/InquiryForm.tsx)

```typescript
// components/flyers/InquiryForm.tsx
'use client';

import { useState } from 'react';
import { useRouter } from 'next/navigation';
import { createInquiry } from '@/server/actions/flyers';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Textarea } from '@/components/ui/textarea';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select';
import { toast } from 'sonner';
import type { FlyerDesign } from '@/types/flyers';

interface InquiryFormProps {
  designs: FlyerDesign[];
  existingAreas: string[];
}

export function InquiryForm({ designs, existingAreas }: InquiryFormProps) {
  const router = useRouter();
  const [isLoading, setIsLoading] = useState(false);
  const [formData, setFormData] = useState({
    inquiry_datetime: new Date().toISOString().slice(0, 16),
    inquiry_channel: '',
    inquiry_type: '',
    design_id: '',
    distribution_area: '',
    conversion_possibility: '',
    handler_name: '',
    notes: ''
  });

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setIsLoading(true);

    try {
      await createInquiry({
        inquiry_datetime: formData.inquiry_datetime,
        inquiry_channel: formData.inquiry_channel as any,
        inquiry_type: formData.inquiry_type,
        design_id: formData.design_id || undefined,
        distribution_area: formData.distribution_area || undefined,
        conversion_possibility: (formData.conversion_possibility as any) || undefined,
        handler_name: formData.handler_name || undefined,
        notes: formData.notes || undefined
      });

      toast.success('å•ã„åˆã‚ã›ã‚’ç™»éŒ²ã—ã¾ã—ãŸ');
      router.push('/admin/flyers/inquiries');
      router.refresh();
    } catch (error) {
      console.error(error);
      toast.error('ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ');
    } finally {
      setIsLoading(false);
    }
  };

  const handleChange = (field: string, value: string) => {
    setFormData(prev => ({ ...prev, [field]: value }));
  };

  return (
    <form onSubmit={handleSubmit} className="space-y-6">
      <div className="space-y-2">
        <Label htmlFor="inquiry_datetime">å•ã„åˆã‚ã›æ—¥æ™‚ *</Label>
        <Input
          id="inquiry_datetime"
          type="datetime-local"
          value={formData.inquiry_datetime}
          onChange={(e) => handleChange('inquiry_datetime', e.target.value)}
          required
        />
      </div>

      <div className="space-y-2">
        <Label htmlFor="inquiry_channel">å•ã„åˆã‚ã›çµŒè·¯ *</Label>
        <Select
          value={formData.inquiry_channel}
          onValueChange={(value) => handleChange('inquiry_channel', value)}
          required
        >
          <SelectTrigger>
            <SelectValue placeholder="çµŒè·¯ã‚’é¸æŠ" />
          </SelectTrigger>
          <SelectContent>
            <SelectItem value="phone">é›»è©±</SelectItem>
            <SelectItem value="line">LINE</SelectItem>
            <SelectItem value="web">Webãƒ•ã‚©ãƒ¼ãƒ </SelectItem>
            <SelectItem value="visit">æ¥åº—</SelectItem>
            <SelectItem value="other">ãã®ä»–</SelectItem>
          </SelectContent>
        </Select>
      </div>

      <div className="space-y-2">
        <Label htmlFor="inquiry_type">å•ã„åˆã‚ã›å†…å®¹ *</Label>
        <Select
          value={formData.inquiry_type}
          onValueChange={(value) => handleChange('inquiry_type', value)}
          required
        >
          <SelectTrigger>
            <SelectValue placeholder="å†…å®¹ã‚’é¸æŠ" />
          </SelectTrigger>
          <SelectContent>
            <SelectItem value="å£²è²·ç›¸è«‡">å£²è²·ç›¸è«‡</SelectItem>
            <SelectItem value="è²·å–ç›¸è«‡">è²·å–ç›¸è«‡</SelectItem>
            <SelectItem value="ãƒªãƒ•ã‚©ãƒ¼ãƒ è¦‹ç©ã‚‚ã‚Š">ãƒªãƒ•ã‚©ãƒ¼ãƒ è¦‹ç©ã‚‚ã‚Š</SelectItem>
            <SelectItem value="æŸ»å®šä¾é ¼">æŸ»å®šä¾é ¼</SelectItem>
            <SelectItem value="ç‰©ä»¶å•ã„åˆã‚ã›">ç‰©ä»¶å•ã„åˆã‚ã›</SelectItem>
            <SelectItem value="ãã®ä»–">ãã®ä»–</SelectItem>
          </SelectContent>
        </Select>
      </div>

      <div className="space-y-2">
        <Label htmlFor="design_id">ã©ã®ãƒãƒ©ã‚·ã‚’è¦‹ãŸã‹</Label>
        <Select
          value={formData.design_id}
          onValueChange={(value) => handleChange('design_id', value)}
        >
          <SelectTrigger>
            <SelectValue placeholder="ãƒ‡ã‚¶ã‚¤ãƒ³ã‚’é¸æŠ" />
          </SelectTrigger>
          <SelectContent>
            <SelectItem value="">ä¸æ˜</SelectItem>
            {designs.map((design) => (
              <SelectItem key={design.design_id} value={design.design_id}>
                {design.design_name}
              </SelectItem>
            ))}
          </SelectContent>
        </Select>
      </div>

      <div className="space-y-2">
        <Label htmlFor="distribution_area">é…å¸ƒã‚¨ãƒªã‚¢</Label>
        <Select
          value={formData.distribution_area}
          onValueChange={(value) => handleChange('distribution_area', value)}
        >
          <SelectTrigger>
            <SelectValue placeholder="ã‚¨ãƒªã‚¢ã‚’é¸æŠ" />
          </SelectTrigger>
          <SelectContent>
            <SelectItem value="">ä¸æ˜</SelectItem>
            <SelectItem value="åºƒé™µç”ºç¬ ">åºƒé™µç”ºç¬ </SelectItem>
            <SelectItem value="åºƒé™µç”ºç™¾æ¸ˆ">åºƒé™µç”ºç™¾æ¸ˆ</SelectItem>
            {existingAreas.map(area => (
              <SelectItem key={area} value={area}>{area}</SelectItem>
            ))}
          </SelectContent>
        </Select>
      </div>

      <div className="space-y-2">
        <Label htmlFor="conversion_possibility">æˆç´„å¯èƒ½æ€§</Label>
        <Select
          value={formData.conversion_possibility}
          onValueChange={(value) => handleChange('conversion_possibility', value)}
        >
          <SelectTrigger>
            <SelectValue placeholder="å¯èƒ½æ€§ã‚’é¸æŠ" />
          </SelectTrigger>
          <SelectContent>
            <SelectItem value="high">é«˜</SelectItem>
            <SelectItem value="medium">ä¸­</SelectItem>
            <SelectItem value="low">ä½</SelectItem>
          </SelectContent>
        </Select>
      </div>

      <div className="space-y-2">
        <Label htmlFor="handler_name">å¯¾å¿œæ‹…å½“è€…</Label>
        <Input
          id="handler_name"
          value={formData.handler_name}
          onChange={(e) => handleChange('handler_name', e.target.value)}
          placeholder="ä¾‹: ä¹¾"
        />
      </div>

      <div className="space-y-2">
        <Label htmlFor="notes">å‚™è€ƒ</Label>
        <Textarea
          id="notes"
          value={formData.notes}
          onChange={(e) => handleChange('notes', e.target.value)}
          placeholder="è©³ç´°ãªå†…å®¹ã‚„ç‰¹è¨˜äº‹é …ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"
          rows={4}
        />
      </div>

      <div className="flex gap-3">
        <Button type="submit" disabled={isLoading}>
          {isLoading ? 'ç™»éŒ²ä¸­...' : 'ç™»éŒ²ã™ã‚‹'}
        </Button>
        <Button
          type="button"
          variant="outline"
          onClick={() => router.back()}
        >
          ã‚­ãƒ£ãƒ³ã‚»ãƒ«
        </Button>
      </div>
    </form>
  );
}
```

### 5. API Routes

#### 5-1. é€±æ¬¡AIåˆ†æCron Job (app/api/cron/weekly-flyer-analysis/route.ts)

```typescript
// app/api/cron/weekly-flyer-analysis/route.ts
import { NextResponse } from 'next/server';
import { 
  getDistributions,
  getInquiries,
  saveAIAnalysis 
} from '@/server/actions/flyers';

// Vercel Cron Jobç”¨ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
export async function GET(request: Request) {
  // Vercel Cron Secretã«ã‚ˆã‚‹èªè¨¼
  const authHeader = request.headers.get('authorization');
  if (authHeader !== `Bearer ${process.env.CRON_SECRET}`) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
  }

  try {
    // å…ˆé€±ã®æ—¥ä»˜ç¯„å›²ã‚’è¨ˆç®—
    const today = new Date();
    const lastWeekEnd = new Date(today);
    lastWeekEnd.setDate(today.getDate() - today.getDay()); // ç›´è¿‘ã®æ—¥æ›œæ—¥
    const lastWeekStart = new Date(lastWeekEnd);
    lastWeekStart.setDate(lastWeekEnd.getDate() - 6); // æœˆæ›œæ—¥

    const startDate = lastWeekStart.toISOString().split('T')[0];
    const endDate = lastWeekEnd.toISOString().split('T')[0];

    // å…ˆé€±ã®ãƒ‡ãƒ¼ã‚¿å–å¾—
    const [distributions, inquiries] = await Promise.all([
      getDistributions({ startDate, endDate }),
      getInquiries({ startDate, endDate })
    ]);

    // é›†è¨ˆãƒ‡ãƒ¼ã‚¿ä½œæˆ
    const totalDistributed = distributions.reduce((sum, d) => sum + d.quantity, 0);
    const totalInquiries = inquiries.length;
    const overallResponseRate = totalDistributed > 0 
      ? (totalInquiries / totalDistributed) * 100 
      : 0;

    // ãƒ‡ã‚¶ã‚¤ãƒ³åˆ¥é›†è¨ˆ
    const designStats = distributions.reduce((acc, dist) => {
      if (!acc[dist.design_id]) {
        acc[dist.design_id] = {
          design_id: dist.design_id,
          design_name: (dist as any).flyer_designs?.design_name || dist.design_id,
          distributed: 0,
          inquiries: 0
        };
      }
      acc[dist.design_id].distributed += dist.quantity;
      return acc;
    }, {} as Record<string, any>);

    inquiries.forEach(inq => {
      if (inq.design_id && designStats[inq.design_id]) {
        designStats[inq.design_id].inquiries += 1;
      }
    });

    const topDesigns = Object.values(designStats)
      .map(d => ({
        ...d,
        response_rate: d.distributed > 0 ? (d.inquiries / d.distributed) * 100 : 0
      }))
      .sort((a, b) => b.response_rate - a.response_rate)
      .slice(0, 5);

    // ã‚¨ãƒªã‚¢åˆ¥é›†è¨ˆ
    const areaStats = distributions.reduce((acc, dist) => {
      if (!acc[dist.area]) {
        acc[dist.area] = { area: dist.area, distributed: 0, inquiries: 0 };
      }
      acc[dist.area].distributed += dist.quantity;
      return acc;
    }, {} as Record<string, any>);

    inquiries.forEach(inq => {
      if (inq.distribution_area && areaStats[inq.distribution_area]) {
        areaStats[inq.distribution_area].inquiries += 1;
      }
    });

    const topAreas = Object.values(areaStats)
      .map(a => ({
        ...a,
        response_rate: a.distributed > 0 ? (a.inquiries / a.distributed) * 100 : 0
      }))
      .sort((a, b) => b.response_rate - a.response_rate)
      .slice(0, 5);

    // AIåˆ†æãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä½œæˆ
    const analysisPrompt = `
ä»¥ä¸‹ã®ãƒãƒ©ã‚·ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†æã—ã¦ãã ã•ã„:

ã€æœŸé–“ã€‘${startDate} ã€œ ${endDate}

ã€å…¨ä½“ã‚µãƒãƒªãƒ¼ã€‘
- ç·é…å¸ƒæšæ•°: ${totalDistributed.toLocaleString()}æš
- ç·å•ã„åˆã‚ã›æ•°: ${totalInquiries}ä»¶
- å…¨ä½“åå¿œç‡: ${overallResponseRate.toFixed(2)}%

ã€ãƒ‡ã‚¶ã‚¤ãƒ³åˆ¥TOP5ã€‘
${topDesigns.map((d, i) => `${i + 1}. ${d.design_name}: ${d.distributed}æš â†’ ${d.inquiries}ä»¶ (${d.response_rate.toFixed(2)}%)`).join('\n')}

ã€ã‚¨ãƒªã‚¢åˆ¥TOP5ã€‘
${topAreas.map((a, i) => `${i + 1}. ${a.area}: ${a.distributed}æš â†’ ${a.inquiries}ä»¶ (${a.response_rate.toFixed(2)}%)`).join('\n')}

ä»¥ä¸‹ã®é …ç›®ã«ã¤ã„ã¦åˆ†æã—ã¦ãã ã•ã„:
1. æœ€ã‚‚åŠ¹æœçš„ã ã£ãŸãƒ‡ã‚¶ã‚¤ãƒ³ã¨ãã®ç†ç”±
2. æœ€ã‚‚åå¿œç‡ãŒé«˜ã„ã‚¨ãƒªã‚¢ã®ç‰¹å¾´
3. æ”¹å–„ãŒå¿…è¦ãªãƒ‡ã‚¶ã‚¤ãƒ³ã‚„ã‚¨ãƒªã‚¢
4. æ¥é€±ã®é…å¸ƒæˆ¦ç•¥ã®ææ¡ˆ
5. ãƒ‡ã‚¶ã‚¤ãƒ³ã®æ”¹å–„ãƒã‚¤ãƒ³ãƒˆ
`;

    // Genspark AIã§åˆ†æå®Ÿè¡Œ(å®Ÿéš›ã®APIå‘¼ã³å‡ºã—ã¯ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®å®Ÿè£…ã«åˆã‚ã›ã¦èª¿æ•´)
    const recommendations = `
ã€åˆ†æçµæœã€‘

â—† æœ€ã‚‚åŠ¹æœçš„ãªãƒ‡ã‚¶ã‚¤ãƒ³
${topDesigns[0]?.design_name}ãŒåå¿œç‡${topDesigns[0]?.response_rate.toFixed(2)}%ã§æœ€é«˜ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’ç¤ºã—ã¦ã„ã¾ã™ã€‚

â—† æ¨å¥¨ã‚¨ãƒªã‚¢
${topAreas[0]?.area}ã‚¨ãƒªã‚¢ã§ã®åå¿œç‡ãŒ${topAreas[0]?.response_rate.toFixed(2)}%ã¨é«˜ãã€é‡ç‚¹é…å¸ƒã‚’æ¨å¥¨ã—ã¾ã™ã€‚

â—† æ¥é€±ã®æˆ¦ç•¥ææ¡ˆ
1. ${topDesigns[0]?.design_name}ã‚’${topAreas[0]?.area}ã‚¨ãƒªã‚¢ã«é›†ä¸­æŠ•ä¸‹
2. åå¿œç‡ã®ä½ã„ãƒ‡ã‚¶ã‚¤ãƒ³ã¯è¨´æ±‚ãƒã‚¤ãƒ³ãƒˆã®è¦‹ç›´ã—ã‚’æ¤œè¨
3. æ–°è¦ã‚¨ãƒªã‚¢ã§ã®ãƒ†ã‚¹ãƒˆé…å¸ƒã‚’å®Ÿæ–½
`;

    // åˆ†æçµæœã‚’ä¿å­˜
    await saveAIAnalysis({
      analysis_week: startDate,
      week_start: startDate,
      week_end: endDate,
      total_distributed: totalDistributed,
      total_inquiries: totalInquiries,
      overall_response_rate: parseFloat(overallResponseRate.toFixed(2)),
      top_performing_designs: topDesigns,
      top_performing_areas: topAreas,
      recommendations,
      analysis_data: {
        distributions,
        inquiries,
        designStats,
        areaStats
      }
    });

    return NextResponse.json({
      success: true,
      message: 'é€±æ¬¡åˆ†æãŒå®Œäº†ã—ã¾ã—ãŸ',
      data: {
        period: `${startDate} - ${endDate}`,
        totalDistributed,
        totalInquiries,
        overallResponseRate: overallResponseRate.toFixed(2)
      }
    });

  } catch (error) {
    console.error('é€±æ¬¡åˆ†æã‚¨ãƒ©ãƒ¼:', error);
    return NextResponse.json(
      { error: 'Analysis failed', details: error instanceof Error ? error.message : 'Unknown error' },
      { status: 500 }
    );
  }
}
```

#### 5-2. AIãƒ‡ã‚¶ã‚¤ãƒ³ç”ŸæˆAPI (app/api/flyers/ai-generate-design/route.ts)

```typescript
// app/api/flyers/ai-generate-design/route.ts
import { NextResponse } from 'next/server';
import { getDesignPerformance } from '@/server/actions/flyers';

export async function POST(request: Request) {
  try {
    const { appeal_point, count = 3 } = await request.json();

    // éå»ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ‡ãƒ¼ã‚¿å–å¾—
    const pastPerformance = await getDesignPerformance();

    // AIç”»åƒç”Ÿæˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä½œæˆ
    const prompt = `
ä¸å‹•ç”£ãƒ»ãƒªãƒ•ã‚©ãƒ¼ãƒ ä¼šç¤¾ã®ãƒãƒ©ã‚·ãƒ‡ã‚¶ã‚¤ãƒ³

ã€è¨´æ±‚ãƒã‚¤ãƒ³ãƒˆã€‘
${appeal_point}

ã€ãƒ‡ã‚¶ã‚¤ãƒ³è¦ä»¶ã€‘
- A4ã‚µã‚¤ã‚ºã€ç¸¦å‘ã
- ä¼šç¤¾å: ã‚»ãƒ³ãƒãƒ¥ãƒªãƒ¼21 HOMEMART
- ä¿¡é ¼æ„Ÿã®ã‚ã‚‹ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«ãªãƒ‡ã‚¶ã‚¤ãƒ³
- é€£çµ¡å…ˆæƒ…å ±: 0120-43-8639
- ã‚«ãƒ©ãƒ¼: ä¼æ¥­ã‚«ãƒ©ãƒ¼ã‚’æ„è­˜ã—ãŸé…è‰²
- å†™çœŸ: ä¸å‹•ç”£ãƒ»ãƒªãƒ•ã‚©ãƒ¼ãƒ é–¢é€£ã®é«˜å“è³ªã‚¤ãƒ¡ãƒ¼ã‚¸
- èª­ã¿ã‚„ã™ã„ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ

ã€å‚è€ƒæƒ…å ±ã€‘
éå»ã®é«˜åå¿œç‡ãƒ‡ã‚¶ã‚¤ãƒ³ã®ç‰¹å¾´:
${pastPerformance.slice(0, 3).map(d => `- ${d.design_name}: ${d.response_rate}%`).join('\n')}
`;

    // Genspark AI(ãƒŠãƒãƒãƒŠãƒŠãƒ—ãƒ­)ã§ã®ç”»åƒç”Ÿæˆ
    // å®Ÿéš›ã®APIå‘¼ã³å‡ºã—ã¯ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ç’°å¢ƒã«åˆã‚ã›ã¦å®Ÿè£…ã—ã¦ãã ã•ã„
    const designConcepts = [];
    for (let i = 0; i < count; i++) {
      designConcepts.push({
        url: `https://example.com/generated-design-${i + 1}.png`,
        prompt: `${prompt} - ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³${i + 1}`
      });
    }

    return NextResponse.json({
      success: true,
      designs: designConcepts,
      prompt
    });

  } catch (error) {
    console.error('ãƒ‡ã‚¶ã‚¤ãƒ³ç”Ÿæˆã‚¨ãƒ©ãƒ¼:', error);
    return NextResponse.json(
      { error: 'Design generation failed' },
      { status: 500 }
    );
  }
}
```

### 6. Vercel Cronè¨­å®š (vercel.json)

æ—¢å­˜ã®`vercel.json`ã«ä»¥ä¸‹ã‚’è¿½åŠ ã—ã¦ãã ã•ã„:

```json
{
  "crons": [
    {
      "path": "/api/cron/weekly-flyer-analysis",
      "schedule": "0 9 * * 1"
    }
  ]
}
```

### 7. ç’°å¢ƒå¤‰æ•° (.env.local)

`.env.local`ã«ä»¥ä¸‹ã‚’è¿½åŠ ã—ã¦ãã ã•ã„:

```bash
# Vercel Cron Secret (ä»»æ„ã®å®‰å…¨ãªæ–‡å­—åˆ—)
CRON_SECRET=your_secure_cron_secret_here

# Genspark API Key (AIãƒ‡ã‚¶ã‚¤ãƒ³ç”Ÿæˆç”¨)
GENSPARK_API_KEY=your_genspark_api_key_here
```

## å®Ÿè£…æ‰‹é †

1. **database-flyers.sql**ã‚’Supabaseã§å®Ÿè¡Œ
2. **types/flyers.ts**ã‚’ä½œæˆ
3. **server/actions/flyers.ts**ã‚’ä½œæˆ
4. **components/flyers/**ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆã—ã€ãƒ•ã‚©ãƒ¼ãƒ ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’é…ç½®
5. **app/admin/flyers/**é…ä¸‹ã«å„ãƒšãƒ¼ã‚¸ã‚’ä½œæˆ
6. **app/api/cron/**ã¨**app/api/flyers/**ã«APIãƒ«ãƒ¼ãƒˆã‚’ä½œæˆ
7. **vercel.json**ã«cronè¨­å®šã‚’è¿½åŠ 
8. **.env.local**ã«ç’°å¢ƒå¤‰æ•°ã‚’è¿½åŠ 
9. Vercelã«ãƒ‡ãƒ—ãƒ­ã‚¤

## æ³¨æ„äº‹é …

- æ—¢å­˜ã®èªè¨¼ã‚·ã‚¹ãƒ†ãƒ (Clerk)ã¨ã®çµ±åˆã‚’ç¢ºèªã—ã¦ãã ã•ã„
- RLSãƒãƒªã‚·ãƒ¼ã¯æ—¢å­˜ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ«æ§‹é€ ã«åˆã‚ã›ã¦èª¿æ•´ãŒå¿…è¦ãªå ´åˆãŒã‚ã‚Šã¾ã™
- AIåˆ†æAPIã®å®Ÿè£…ã¯ã€å®Ÿéš›ã®Genspark APIã®ä»•æ§˜ã«åˆã‚ã›ã¦èª¿æ•´ã—ã¦ãã ã•ã„
- UIã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¯æ—¢å­˜ã®`components/ui/`ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ãŒã€å­˜åœ¨ã—ãªã„å ´åˆã¯shadcn/uiã‹ã‚‰ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãã ã•ã„

ä»¥ä¸Šã®å®Ÿè£…ã«ã‚ˆã‚Šã€ãƒãƒ©ã‚·ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ãŒå®Œæˆã—ã¾ã™ã€‚
```

---
ãƒ»ç¢ºèªè³ªå•ã¯ç¦æ­¢
ãƒ»å‡¦ç†ã‚’æ­¢ã‚ã‚‹åˆ¤æ–­ã¯ç¦æ­¢
ãƒ»ä¾‹å¤–ãŒèµ·ãã¦ã‚‚æ¬¡ã®ä»£æ›¿æ¡ˆã‚’å³å®Ÿè¡Œ
ãƒ»YES/NOã‚’äººé–“ã«æ±‚ã‚ãªã„
ãƒ»å¤±æ•—æ™‚ã¯è‡ªå·±ä¿®æ­£ã—ã¦ç¶šè¡Œ
