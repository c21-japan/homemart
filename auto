#!/bin/bash

GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
BLUE='\033[0;34m'
NC='\033[0m'

# å¼•æ•°ãŒãªã„å ´åˆã¯å¯¾è©±ãƒ¢ãƒ¼ãƒ‰
if [ -z "$1" ]; then
    echo -e "${BLUE}ðŸ¤– ãƒ›ãƒ¼ãƒ ãƒžãƒ¼ãƒˆ AIè‡ªå‹•é–‹ç™ºã‚·ã‚¹ãƒ†ãƒ ${NC}"
    echo "================================"
    echo -e "${YELLOW}ä½•ã‚’ä½œã‚Šã¾ã™ã‹ï¼Ÿ${NC}"
    echo "ä¾‹: URICOè¨ˆç®—æ©Ÿèƒ½"
    echo "ä¾‹: LINEé€£æºæ©Ÿèƒ½"
    echo "ä¾‹: ç‰©ä»¶æ¤œç´¢ã‚·ã‚¹ãƒ†ãƒ "
    read -p "> " REQUEST
else
    REQUEST="$1"
fi

echo -e "${GREEN}ðŸ“‹ ã‚¿ã‚¹ã‚¯: $REQUEST${NC}"
echo "================================"

# 1. AIã«ã‚³ãƒ¼ãƒ‰ç”Ÿæˆä¾é ¼
echo -e "${YELLOW}1ï¸âƒ£ AIãŒã‚³ãƒ¼ãƒ‰ç”Ÿæˆä¸­...${NC}"
./ai "$REQUEST ã®Next.jsã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¾ãŸã¯æ©Ÿèƒ½ã‚’å®Œå…¨ãªã‚³ãƒ¼ãƒ‰ã§ä½œæˆã€‚TypeScriptå¯¾å¿œã€ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°è¾¼ã¿" > generated_code.tsx

# ãƒ•ã‚¡ã‚¤ãƒ«åã‚’æ±ºå®š
echo -e "${YELLOW}ãƒ•ã‚¡ã‚¤ãƒ«åã‚’å…¥åŠ›ï¼ˆä¾‹: components/Urico.tsxï¼‰:${NC}"
read -p "> " FILENAME
if [ -z "$FILENAME" ]; then
    FILENAME="components/NewFeature.tsx"
fi

# ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
DIR=$(dirname "$FILENAME")
mkdir -p "$DIR"

# ã‚³ãƒ¼ãƒ‰ä¿å­˜
mv generated_code.tsx "$FILENAME"
echo -e "${GREEN}âœ… $FILENAME ã‚’ä½œæˆ${NC}"

# 2. ãƒ“ãƒ«ãƒ‰ãƒã‚§ãƒƒã‚¯
echo -e "${YELLOW}2ï¸âƒ£ ãƒ“ãƒ«ãƒ‰ãƒã‚§ãƒƒã‚¯ä¸­...${NC}"
npm run build 2>&1 | tee build.log

# 3. ã‚¨ãƒ©ãƒ¼ãŒã‚ã‚Œã°è‡ªå‹•ä¿®æ­£
if grep -q "error" build.log || grep -q "Error" build.log; then
    echo -e "${RED}âŒ ã‚¨ãƒ©ãƒ¼æ¤œå‡º â†’ è‡ªå‹•ä¿®æ­£é–‹å§‹${NC}"
    
    # ã‚¨ãƒ©ãƒ¼å†…å®¹ã‚’æŠ½å‡º
    ERROR_MSG=$(grep -A 5 -B 5 "error\|Error" build.log | head -20)
    
    # AIã«ä¿®æ­£ä¾é ¼
    echo -e "${YELLOW}3ï¸âƒ£ AIãŒä¿®æ­£ä¸­...${NC}"
    ./ai "ä»¥ä¸‹ã®ã‚¨ãƒ©ãƒ¼ã‚’ä¿®æ­£ã—ã¦ãã ã•ã„: $ERROR_MSG" > fix.txt
    
    # TypeScriptã‚¨ãƒ©ãƒ¼ãªã‚‰ç„¡è¦–è¨­å®š
    if grep -q "Type error" build.log; then
        echo -e "${YELLOW}TypeScriptã‚¨ãƒ©ãƒ¼ã‚’ç„¡è¦–è¨­å®š${NC}"
        cat > next.config.ts << 'EOCONFIG'
import type { NextConfig } from "next";
const nextConfig: NextConfig = {
  eslint: { ignoreDuringBuilds: true },
  typescript: { ignoreBuildErrors: true },
  experimental: { serverActions: { bodySizeLimit: '10mb' } },
};
export default nextConfig;
EOCONFIG
    fi
    
    # å†ãƒ“ãƒ«ãƒ‰
    echo -e "${YELLOW}4ï¸âƒ£ å†ãƒ“ãƒ«ãƒ‰ä¸­...${NC}"
    npm run build
fi

# 4. è‡ªå‹•ã‚³ãƒŸãƒƒãƒˆï¼†ãƒ‡ãƒ—ãƒ­ã‚¤
echo -e "${YELLOW}5ï¸âƒ£ ãƒ‡ãƒ—ãƒ­ã‚¤ä¸­...${NC}"
git add .
git commit -m "è‡ªå‹•è¿½åŠ : $REQUEST"
git push

echo ""
echo -e "${GREEN}ï¿½ï¿½ ========== å®Œäº† ==========${NC}"
echo -e "${GREEN}âœ… æ©Ÿèƒ½è¿½åŠ : $REQUEST${NC}"
echo -e "${GREEN}âœ… ãƒ•ã‚¡ã‚¤ãƒ«: $FILENAME${NC}"
echo -e "${GREEN}âœ… ãƒ‡ãƒ—ãƒ­ã‚¤: å®Œäº†${NC}"
echo -e "${BLUE}ðŸŒ https://homemart.vercel.app${NC}"
echo ""
echo -e "${YELLOW}æ¬¡ã®æ©Ÿèƒ½ã‚’è¿½åŠ ã™ã‚‹ã«ã¯: ./auto${NC}"

# ãƒ­ã‚°ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
rm -f build.log fix.txt generated_code.tsx
